#!/bin/bash

set -euo pipefail

# Template logic: use exact hostname as profile, fallback to 'devcontainer' if not found
{{- $profile := output "hostname" }}
{{- $profiles := index .profiles $profile | default (index .profiles "devcontainer") }}
{{- $commands := .commands }}
{{- $managers := index . "pacakage-managers" }}
{{- $packages := .packages }}

echo "🚀 Applying profile: {{ $profile }}"
echo -n "📦 Resolved groups:"
{{- range $profiles }} echo -n " {{ . }}"{{ end }}
echo

# Loop over each group in the profile
{{- range $group := $profiles }}
  echo "🔧 Processing group: {{ $group }}"

  {{- $groupManagers := index $managers $group }}
  {{- if $groupManagers }}
    {{- range $manager := $groupManagers }}
      echo "  🛠️ Using manager: {{ $manager }}"

      {{- $cmd := index $commands $manager | join " " }}
      {{- $groupPackages := index (index $packages $group) $manager }}

      {{- if $groupPackages }}
        {{- range $pkg := $groupPackages }}
          echo "    📦 Installing {{ $pkg }} with {{ $manager }}"
          {{ $cmd }} {{ $pkg }}
        {{- end }}
      {{- else }}
        echo "    ⚠️ No packages defined for manager '{{ $manager }}' in group '{{ $group }}'"
      {{- end }}
    {{- end }}
  {{- else }}
    echo "  ⚠️ No managers defined for group '{{ $group }}'"
  {{- end }}
{{- end }}

